## esp32dali2mqtt 有线网关

esp32dali2mqtt 是一款支持 DALI2 转换到 mqtt 协议的有线网关，用于dali 灯具接入 home assistant，也可以用于通过mqtt控制dali灯具。

### 主要特点

- dali2 协议，支持短地址扫描、分配、全部初始化等功能；
- Homeassistant 自动发现(DT6/DT8)，便于管理；
- 处理器为 eps32，资源充足、省电环保；
- 有线网络，稳定可靠；
- ha 下打开或关闭组，组内灯具状态会相应更新；
- DIN 导轨支持，便于放置配电箱；
- 单路 DALI, 4个接线柱，便于接线；
- 220v误接保护，工程适用；
- 需要外接 dail电源，本网关不指供dali电源。

### 接口说明
<br> - RJ45插座：用于接入到交换机。<br> - type-c插座：设备供电（5-24V，500ma)。<br>led指示灯：<br>- 网络指示：闪烁表示无网络，常亮表示已获取IP地址。<br>- DALI接收指示: 闪亮表示正在接收数据，无接收熄灭<br> - DALI发送指示：闪亮表示正在发送数据，无接收熄灭 <br> - mqtt指示：闪烁表示未连接，常亮表示已接入服务器。 |  ![体积小巧](/res/esp32dali2mqtt.png )

### 使用方法
1. 插入网线，接入typec电源；
2. 等待网关获取ip地址（时间约10秒到1分钟，网关名字为 esp32dali2mqtt，可以从路由器上查看，也可以运行 ping esp32dali2mqtt.local 来确认地址，以下假设获取的地址为 192.168.1.99；
3. 网关开始扫描dali总线的所有设备，可以观察到接收和发送指示led闪烁；
3. 首次使用先配置mqtt服务器，详见下节（网关管理界面操作）；
4. 多功能键操作：
    - 单击：用于在全开和全关之间来回切换，按一下全开，再按全关；
    - 双击：用于扫描总线上的灯具，同时向mqtt服务㗊上报结果，可以多次扫描更新；
    - 长按（2秒以上，5秒以下）：对新灯具分配短地址；
    - 长按（6秒以上）：删除所有已分配的地址；

### 网关管理界面操作
1. 进入管理界面：在同一网络下的电脑或手机的浏览器里输入 网关地址，如http://192.168.1.99, 打开网关管理页面;
2. 配置 mqtt 服务器：选择 mqtt，进入配置页面，输入mqtt服务器的 ip 地址（如192.168.1.200) 和 端口(如1883)，根据服务器的配置情况输入用户名和密码，按submit进行上传，此时网络会重启，等待网关启动完成（接收和发送指示led停止闪烁后熄灭）；
3. 配置 wifi 参数：（暂未实现）；
3. 分组操作：选择 group，页面会显示扫描后发现的所有灯具和分组信息，直接点击某灯具的分组编号即可将其加入或离开这一分组；
4. 灯具直接操作：在 group 页面，点击 灯具后面的 亮度，会打开或关闭该灯具；
5. 其他命令：选择 command 页面后：
    - toggle：切换所有灯具全开和全关；
    - scan：扫描短地址；
    - assign: 为新灯具分配短地址；
    - delete：删除所有短地址
6. 固件升级：选择firmware，然后选择新固件上传即可。

### 其他说明
1. 由于dali系统短地址随机分配，删除后再分配的短地址会和原来不一致，建议删除功能慎用；
2. 如果遇到某个灯具没有被发现，可以多次扫描；
3. 无网络或网线不插的情况下，可以直接使用多功能键进行操作；
4. 网关不提供总线电源。

### TODO
1. 实现无网线时启动 wifi, 便于工程环境测试。